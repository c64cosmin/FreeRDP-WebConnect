<!DOCTYPE html>
<html>
    <head>
        <title>FreeRDP WebConnect: offline</title>
        <link href='http://fonts.googleapis.com/css?family=Ropa+Sans' rel='stylesheet' type='text/css'>
        <meta charset="utf-8" />
        <meta name="robots" content="noindex, nofollow" />
        <meta name="description" content="HTML5 based RDP client">
        <meta name="author" content="CloudBase Solutions">
        <meta name="viewport" content="width=device-width height=device-height user-scalable=no">
        <meta name="cursor-event-mode" content="native">
        <meta name="touch-event-mode" content="pure-with-mouse-conversion">
        <link rel="stylesheet" href="css/style%JSDEBUG%.css">
        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <script src="js/modernizr%JSDEBUG%.js"></script>
        <script src="js/mootools%JSDEBUG%.js"></script>
        <script src="js/simpletabs%JSDEBUG%.js"></script>
        <script src="js/wsgate%JSDEBUG%.js"></script>
        <script src="js/menu.js"></script>
        <script language="javascript" type="text/javascript">
            var wsBase = "%WSURI%";
            var RIMtablet = navigator.appVersion && (-1 != navigator.appVersion.indexOf('RIM Tablet'));
            var mhx = 100;
            var mhy = 100;
            var dragX = 0;
            var dragY = 0;
            var inDrag = false;
            var rdp = null;
            var embedded = false;

            var externalConnection = false;
            var loginmenu = null;

            function initBody(){
                //apply old settings
                loginmenu = new LoginMenu();
                settingsApply();
                initPopUpDeck();
                initFrontCanvas();
                Animator(update);
            }

            //gets browser native scheduler
            var GetAnimator = function(){
                return  window.requestAnimationFrame       ||
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame    ||
                        window.oRequestAnimationFrame      ||
                        window.msRequestAnimationFrame     ||
                        function( callback ){
                            window.setTimeout(callback, 1000 / 60);
                        };
            }; 
            var Animator = GetAnimator();

            function update(){
                loginmenu.update();
                Animator(update);
            }
            
            //code for frontcanvas;
            var frontCanvas;
            function resizeFrontCanvas(){
                frontCanvas.scale = window.innerHeight / $("screen").height;
                frontCanvas.width = $("screen").width * frontCanvas.scale;
                frontCanvas.height = window.innerHeight;
                frontCanvas.trans = (window.innerWidth - frontCanvas.width)/2;
                frontCanvas.setStyle("left", frontCanvas.trans + "px");
                frontCanvas.setStyle("top", "0px");
                frontCanvas.ctx.transform(frontCanvas.scale, 0, 0, frontCanvas.scale, 0, 0);
                var textAreaInput = $("textareainput");
                if(textAreaInput != null){
                    textAreaInput.setStyle("left", frontCanvas.trans + "px");
                    textAreaInput.setStyle("top", "0px");
                    textAreaInput.setStyle("width", $("screen").width * frontCanvas.scale);
                    textAreaInput.setStyle("height", $("screen").height * frontCanvas.scale);
                }
                refreshFrontCanvas();
            }
            function refreshFrontCanvas(){
                frontCanvas.ctx.drawImage($("screen"),0,0);
            }
            function clearFrontCanvas(){
                frontCanvas.ctx.clearRect(0, 0, frontCanvas.width / frontCanvas.scale, frontCanvas.height / frontCanvas.scale);
            }
            function initFrontCanvas(){
                frontCanvas = $("frontscreen");
                frontCanvas.scale = 1;
                frontCanvas.trans = 0;
                frontCanvas.ctx = frontCanvas.getContext("2d");
                frontCanvas.width = $("screen").width;
                frontCanvas.height = $("screen").height;
            }

            //pop up message procedure
            var popUpDeck = null;
            var popUpElements = [];

            function initPopUpDeck(){
                popUpDeck = document.createElement('div');
                document.body.appendChild(popUpDeck);

                popUpDeck.set('class', 'popupwrapper');
            }

            function cleanPopUpDeck(){
                for(var i=0; i<popUpElements.length; i++){
                    popUpElements[i].removeEvents();
                    popUpElements[i].destroy();
                }
            }

            function popUpMessage(type, msg, timeout, callback, center){
                var newMessage = document.createElement('div');
                popUpDeck.appendChild(newMessage);
                newMessage.set('class', 'popupmessage');
                newMessage.set('text', msg);
                newMessage.addEvent('mousedown',
                    function(){
                        if(callback)
                            callback();
                        newMessage.destroy();
                        newMessage = null;
                    });

                var color = {
                    r: 255,
                    g: 255,
                    b: 255
                };

                if(type=='error'){
                    color.r = 247;
                    color.g = 203;
                    color.b = 30;
                }else
                if(type=='message'){
                    color.r = 107;
                    color.g = 180;
                    color.b = 229;
                }else
                if(type=='critical'){
                    color.r = 255;
                    color.g = 0;
                    color.b = 0;
                }

                if(center){
                    newMessage.setStyle('position','absolute');
                    newMessage.setStyle('top', document.body.offsetHeight/2);
                    newMessage.setStyle('z-index', '1235');
                }
                newMessage.setStyle('background-color','rgba(' + color.r
                                                         + ',' + color.g
                                                         + ',' + color.b
                                                         + ', 0.8)' );

                if(timeout){
                    window.setTimeout(
                        function(){
                            if(newMessage){
                                if(callback)
                                    callback();
                                newMessage.destroy();
                            }
                        },
                        timeout*1000);
                }

                popUpElements.push(newMessage);

                return newMessage;
            }

            function noInstancePopUp(){
                popUpMessage('critical', "This instance seems to be not working. Try to enter the console again.", 0, noInstancePopUp, true);
            }

            function RDPStart(uri, title){
                if(uri === undefined){
                    uri = wsBase;
                }
                if(title === undefined){
                    title = "FreeRDP WebConnect: connected to " + $('rdphost').value.trim();
                }
                if(!embedded){
                    $('dvLoading').setStyles({'visibility':'visible'});
                }
                rdp = new wsgate.RDP(uri, $('screen'), !RIMtablet, RIMtablet);

                rdp.addEvent('alert', function(msg) {
                    popUpMessage('error', msg, 5);
                    });
                rdp.addEvent('connected', function() {
                        cleanPopUpDeck();
                        document.title = title;
                        button = $("rdpconnect");
                        button.removeEvents();
                        button.value = 'Disconnect';
                        button.addEvent('click', rdp.Disconnect.bind(rdp));
                        window.addEvent("beforeunload", rdp.Disconnect.bind(rdp));
                        });
                rdp.addEvent('disconnected', function() {
                        showDialog(true);
                        if(embedded){
                            $('maindialog').addClass('invisible');
                            noInstancePopUp()
                        }
                        button = $("rdpconnect");
                        button.removeEvents();
                        button.value = 'Connect';
                        button.addEvent('click', function(){RDPStart();});
                        window.addEvent('resize', OnDesktopSize);
                        });
                rdp.addEvent('mouserelease', ResetRdpMouseFlags);
                rdp.addEvent('touch2', function() {
                    ShowMouseHelper($('mousehelper').hasClass('invisible'));
                });
                rdp.addEvent('touch4', function() {
                    if (confirm('Are you sure you want to disconnect?')) {
                        rdp.Disconnect();
                    }
                });
                showDialog(false);
                rdp.Run();
            }

            function SetRdpMouseFlags() {
                var mf = {
                    'r': $('rclick').checked,
                    'm': $('mclick').checked,
                    'a': $('aclick').checked,
                    's': $('sclick').checked,
                    'c': $('cclick').checked,
                };
                rdp.SetArtificialMouseFlags(mf);
            }
            function ResetRdpMouseFlags() {
                $('rclick').checked = false;
                $('mclick').checked = false;
                $('aclick').checked = false;
                $('sclick').checked = false;
                $('cclick').checked = false;
                rdp.SetArtificialMouseFlags(null);
            }
            function ShowMouseHelper(show) {
                var mh = $('mousehelper');
                inDrag = false;
                if (show) {
                    mh.setStyles({'position':'absolute','top':mhy,'left':mhx});
                    mh.addEvent('mousedown',DragStart);
                    $('rclick').addEvent('change', SetRdpMouseFlags);
                    $('mclick').addEvent('change', SetRdpMouseFlags);
                    $('aclick').addEvent('change', SetRdpMouseFlags);
                    $('sclick').addEvent('change', SetRdpMouseFlags);
                    $('cclick').addEvent('change', SetRdpMouseFlags);
                    mh.removeClass('invisible');
                } else {
                    mh.removeEvents();
                    mh.addClass('invisible');
                    $('rclick').removeEvents();
                    $('mclick').removeEvents();
                    $('aclick').removeEvents();
                    $('sclick').removeEvents();
                    $('cclick').removeEvents();
                }
            }

            function OnDesktopSize() {
               resizeFrontCanvas();
               DrawLogo();
            }

            function DragStart(evt) {
                var mh = $('mousehelper');
                if (!mh.hasClass('invisible')) {
                    inDrag = true;
                    dragX = evt.page.x;
                    dragY = evt.page.y;
                    window.addEvent('mouseup',DragEnd);
                    window.addEvent('touchmove',DragMove);
                }
            }
            function DragEnd(evt) {
                inDrag = false;
                var mh = $('mousehelper');
                window.removeEvent('touchmove',DragMove);
                window.removeEvent('mouseup',DragEnd);
            }
            function DragMove(evt) {
                if (inDrag) {
                    var dx = evt.page.x - dragX;
                    var dy = evt.page.y - dragY;
                    dragX = evt.page.x;
                    dragY = evt.page.y;
                    var mh = $('mousehelper');
                    if (!mh.hasClass('invisible')) {
                        mhx += dx;
                        mhy += dy;
                        mh.setStyles({'top':mhy,'left':mhx});
                    }
                }
            }

            function DrawLogo() {
                    var logo = new Element('img', {'src': 'empty_on_purpose'});
                    logo.addEvent('load', function() {
                var scaleWCoeficient = 0.5;
                var scaleHCoeficient = 0.5;
                            var iw = this.width * scaleWCoeficient;
                            var ih = this.height * scaleHCoeficient;
                            var scale = ($('screen').height - 20) / ih;
                            $('screen').getContext('2d').drawImage(this, 10, 10, Math.round(iw * scale), Math.round(ih * scale));
                    }.bind(logo));
            }

	    var sendDisconnect = function() {
		if (confirm('Are you sure you want to disconnect ?')) {
		    $('extracommands').setStyles({'visibility':'hidden'});
		    rdp.Disconnect();
		}
            }

            var altTabOn = false;
            function altTabEvent(){
                if(altTabOn){
                    altTabOn = false;
                    rdp.SendKey(2);//alt+tab release
                    $('alttab').removeClass('extracommandshold');
                }
                else{
                    altTabOn = true;
                    rdp.SendKey(1);//alt+tab
                    $('alttab').addClass('extracommandshold');
                }
            }

            function showDialog(show) {
                if (show) {
                    ShowMouseHelper(false);
                    var dlg = $('maindialog');
                    var x = Math.round((window.getCoordinates().width - dlg.getCoordinates().width) / 2) + 'px';
                    var y = Math.round((window.getCoordinates().height - dlg.getCoordinates().height) / 2) + 'px';
                    $('extracommands').setStyles(
                    {
                        'visibility':'hidden'
                    });
                    $('dvLoading').setStyles(
                    {
                        'visibility':'hidden'
                    });
                    DrawLogo();
                    dlg.setStyles({
                            'position': 'absolute',
                            'top': y,
                            'left': x,
                            }).removeClass('invisible');
                } else {
                    $('maindialog').addClass('invisible');
                    $('extracommands').setStyles(
                    {
                        'visibility':'visible'
                    });
                    $('ctrlaltdelete').addEvent('click', function(){ rdp.SendKey(0); });
                    $('alttab').addEvent('click', altTabEvent);
                    $('disconnect').addEvent('click', sendDisconnect);
                }
            }

            var RDPCookieKey = "RDPinfoJSON";
            //sets a cookie with the settings inserted in the form
            function settingsSet(){
                var infoJSON = settingsGetJSON();
                //remove password
                infoJSON.pass = "";
                document.cookie = RDPCookieKey + "=" + JSON.stringify(infoJSON) + "; expires=Fri, 31 Dec 2030 23:59:59 GMT;";
            }
            //change the form fields with respect with the cookie
            function settingsApply(){
                var cookie = document.cookie;
                if(cookie){
                    var cookieValues = cookie.split(';');
                    var i = 0;
                    //get the cookie for infoJSON
                    while(cookieValues[i].indexOf(RDPCookieKey) == -1){
                        i++;
                    }
                    //get the value of the cookie then parse it to a JSON
                    try{
                        var infoJSON = JSON.parse(cookieValues[i].split('=')[1]);
                        //if we found a JSON we apply the values to the form fields
                        if(infoJSON){
                            $('rdphost').set('value',infoJSON.host);
                            $('rdpport').set('value',infoJSON.port);
                            $('rdppcb').set('value',infoJSON.pcb);
                            $('rdpuser').set('value',infoJSON.user);
                            $('nowallp').set('checked', infoJSON.nowallp != 0);
                            $('nowdrag').set('checked', infoJSON.nowdrag != 0);
                            $('nomani').set('checked', infoJSON.nomani != 0);
                            $('notheme').set('checked', infoJSON.notheme != 0);
                            $('nonla').set('checked', infoJSON.nonla != 0);
                            $('notls').set('checked', infoJSON.notls != 0);
                        }
                    } catch (e){
                        console.log("Bad JSON format");
                        console.log(e.message);
                    }
                }
            }
            //gets a JSON with the settings inserted in the form
            function settingsGetJSON(){
                return {"host"   : $('rdphost').value.trim()
                       ,"port"   : parseInt($('rdpport').value.trim())
                       ,"pcb"    : $('rdppcb').value.trim()
                       ,"user"   : $('rdpuser').value.trim()
                       ,"pass"   : $('rdppass').value
                       ,"perf"   : parseInt($('perf').value.trim())
                       ,"fntlm"  : parseInt($('fntlm').value.trim())
                       ,"nowallp": "0"
                       ,"nowdrag": "0"
                       ,"nomani" : "0"
                       ,"notheme": "0"
                       ,"nonla"  : parseInt($('nonla').checked ? '1' : '0')
                       ,"notls"  : parseInt($('notls').checked ? '1' : '0')
                       ,"dtsize" : $('screen').width + 'x' + $('screen').height
                       };
            }

            window.addEventListener("beforeunload", function() {
                if ($('maindialog').hasClass('invisible')){
                    var ans = confirm("Are you sure you want to disconnect?");
                    if (ans) {
                        rdp.Disconnect();
                    }
                }
            }, false);

            window.addEvent('domready', function() {

                    var querystring = window.location.href.slice(window.location.href.indexOf('?'))

                    var tabs = new SimpleTabs('rdpdialog',{selector:'h4'});
                    if (RIMtablet) {
                        // Set default performance flags to modem
                        $('perf').value = '2';
                    }
                    window.addEvent('resize', OnDesktopSize);
                    // Special handling of webkit nightly builds
                    var webkitOK = false;
                    var wkVA = RegExp("( AppleWebKit/)([^ ]+)").exec(navigator.userAgent);
                    if (wkVA && (wkVA.length > 2)) {
                        if (wkVA[2].indexOf('+') != -1) {
                            webkitOK = true;
                        }
                    }
                    var wsOK = RIMtablet || webkitOK ||
                        (Browser.firefox && (Browser.version >= 11.0)) ||
                        (Browser.chrome && (Browser.version >= 17)) ||
                        (Browser.safari && (Browser.version >= 6)) ||
                        (Browser.ie && (Browser.version >= 10.0));
                    if(externalConnection == true)
                    {
                        RDPStart();
                    }
                    if (wsOK) {
                        if(querystring.length > 2)
                        {
                            showDialog(false);
                            if (querystring.indexOf('token=')>=0){
                                $('disconnect').setStyles({'visibility':'hidden'});
                                embedded = true;
                            }
                            var urlParams;
                            (window.onpopstate = function () {
                                var match,
                                    pl     = /\+/g,  // Regex for replacing addition symbol with a space
                                    search = /([^&=]+)=?([^&]*)/g,
                                    decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
                                    query  = window.location.search.substring(1);

                                urlParams = {};
                                while (match = search.exec(query))
                                   urlParams[decode(match[1])] = decode(match[2]);
                            })();
                            RDPStart(wsBase + querystring, urlParams["title"]);
                        }
                        else
                        {
                            $('rdpconnect').addEvent('click', function(){RDPStart();});
                            showDialog(true);
                        }
                    } else {
                        alert('Sorry!\nYour Browser (' + Browser.name + ' ' + Browser.version
                                + ') does not yet\nprovide the required HTML5 features '
                                + 'for this application.\n');
                    }
            });
        </script>
    </head>
    <body id="wrapper" onload="initBody()" style="overflow:hidden;">
        <div id="extracommands" style="position:absolute; height:28px; background-color:#f1f1f1; padding-left:25px; cursor:default; visibility:hidden;">
            Send keys:
            <ul>

                <li id="ctrlaltdelete">
                    Ctrl+Alt+Delete
                </li>
                <li id="alttab">
                    Alt+Tab
                </li>
                <li id="keyboardlanguage">
                    Multilanguage keyboard
                </li>
            </ul>
            <button id="disconnect" type="button" style="float:right; margin-right:40px; margin-top:2px">Disconnect</button>
        </div>
        <div id="IMEhelper" style="z-index:1111;visibility:hidden;height:auto;width:auto;display:inline;position:absolute;background-color:#ffffff;"></div>
        <canvas id="screen" style="position:absolute;visibility:hidden;margin:0;border:0">
        </canvas>
        <canvas id="frontscreen" style="margin:0;border:0;position:absolute;">
        <p class="error">Sorry, It looks as though your browser does not support the canvas tag.</p>
        </canvas>
        <div id="dvLoading" style="position:fixed; left:45%; top:45%; visibility:hidden;"><img src="images/loading.gif"></div>
        <noscript><p class="error">Please enable JavaScript.</p></noscript>
    </body>
</html>
